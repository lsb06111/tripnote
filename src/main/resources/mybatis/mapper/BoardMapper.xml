<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.example.tripnote.dao.BoardDAO">
<select id="listAll" parameterType="BoardParamDTO" resultType="BoardDto">
   SELECT
	    b.id,
	    b.title,
	    board_content,
	    to_char(b.created_at,'YYYY"."MM"."dd') as createdAt,
	    to_char(b.modified_at,'YYYY"."MM"."dd') as modifiedAt,
	    u.nickname,
	    a.area_name,
	    b.thumbnail,
	    l.likes
	FROM
    	board b
        JOIN users  u ON b.user_id = u.id
        JOIN course c ON b.course_id = c.id
        JOIN area   a ON c.area_id = a.id
        LEFT JOIN (
            SELECT
                board_id,
                COUNT(*) AS likes
            FROM
                likes
            GROUP BY
                board_id
        )   l ON b.id = l.board_id
    
    <where>
    	<if test="loc != null and loc != '' and loc != 'undefined'">
    		and area_name = #{loc}
    	</if>
    	<if test="keyword != null and keyword != ''">
    		and (b.title like '%' || #{keyword} || '%'
    			or b.board_content like '%' || #{keyword} || '%'
    			or a.area_name like '%' || #{keyword} || '%')
    	</if>
    </where>
    <choose>
	    <when test="order == 'latest'">
	    	ORDER BY b.created_at DESC
	    </when>
	    <when test="order == 'like'">
	     	ORDER BY l.likes DESC NULLS LAST
	    </when>
	    <otherwise>
	     	ORDER BY b.created_at DESC
	    </otherwise>
    </choose>
    

</select>

</mapper>